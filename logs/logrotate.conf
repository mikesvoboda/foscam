# Logrotate configuration for Foscam Detection System
# This file handles log rotation, compression, and cleanup

# Main log files - daily rotation with 30-day retention
/home/msvoboda/foscam/logs/webui.log
/home/msvoboda/foscam/logs/crawler.log
/home/msvoboda/foscam/logs/monitor.log {
    # Rotate daily
    daily
    
    # Keep 30 days of logs
    rotate 30
    
    # Compress old logs (except the most recent)
    compress
    delaycompress
    
    # Don't rotate empty files
    notifempty
    
    # Create new log files with these permissions
    create 644 msvoboda msvoboda
    
    # Use date as suffix for rotated logs
    dateext
    dateformat -%Y-%m-%d
    
    # Handle missing log files gracefully
    missingok
    
    # Copy and truncate instead of moving (keeps file handles open)
    copytruncate
    
    # Post-rotation script
    postrotate
        echo "$(date): Main log rotation completed" >> /home/msvoboda/foscam/logs/logrotate.log
    endscript
}

# Uvicorn logs - separate handling  
/home/msvoboda/foscam/logs/*_uvicorn.log {
    # Rotate daily
    daily
    
    # Keep 30 days of logs
    rotate 30
    
    # Compress old logs (except the most recent)
    compress
    delaycompress
    
    # Don't rotate empty files
    notifempty
    
    # Create new log files with these permissions
    create 644 msvoboda msvoboda
    
    # Use date as suffix for rotated logs
    dateext
    dateformat -%Y-%m-%d
    
    # Handle missing log files gracefully
    missingok
    
    # Copy and truncate instead of moving (keeps file handles open)
    copytruncate
    
    postrotate
        echo "$(date): Uvicorn log rotation completed" >> /home/msvoboda/foscam/logs/logrotate.log
    endscript
}

# Error logs - separate handling
/home/msvoboda/foscam/logs/*_error.log {
    # Rotate daily
    daily
    
    # Keep 30 days
    rotate 30
    
    # Compress immediately due to potential size
    compress
    
    # Don't rotate empty files
    notifempty
    
    # Create new files with correct permissions
    create 644 msvoboda msvoboda
    
    # Use date suffix
    dateext
    dateformat -%Y-%m-%d
    
    # Handle missing files
    missingok
    
    # Copy and truncate
    copytruncate
    
    postrotate
        echo "$(date): Error log rotation completed" >> /home/msvoboda/foscam/logs/logrotate.log
    endscript
}

# Access logs - can be large, rotate more aggressively
/home/msvoboda/foscam/logs/*_access.log {
    # Rotate daily
    daily
    
    # Keep 30 days
    rotate 30
    
    # Compress old logs
    compress
    delaycompress
    
    # Don't rotate empty files
    notifempty
    
    # Create new files
    create 644 msvoboda msvoboda
    
    # Use date suffix
    dateext
    dateformat -%Y-%m-%d
    
    # Handle missing files
    missingok
    
    # Copy and truncate
    copytruncate
    
    postrotate
        echo "$(date): Access log rotation completed" >> /home/msvoboda/foscam/logs/logrotate.log
    endscript
}

# Size-based rotation for emergency cases (100MB+ files)
# Note: This is a safety net for files that grow unexpectedly large
# It only applies when individual log files exceed 100MB 